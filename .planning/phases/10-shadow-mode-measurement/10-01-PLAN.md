---
phase: 10-shadow-mode-measurement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types.ts
  - src/shadow-mode/shadow-types.ts
  - src/shadow-mode/threshold-config.ts
  - src/config/default-config.ts
autonomous: true

must_haves:
  truths:
    - "ShadowModeConfig type exists with per-category enable/disable flags"
    - "Dual thresholds (enforced + shadow) are defined for RTL, Color, and CodeQuality"
    - "TestConfig includes optional shadowMode property"
    - "default-config.ts exports shadow mode enabled with all categories true"
  artifacts:
    - path: "src/shadow-mode/shadow-types.ts"
      provides: "All shadow mode interfaces: ShadowModeConfig, ShadowThresholds, ShadowViolation, ShadowMetrics, ShadowRunResult"
      exports: ["ShadowModeConfig", "ShadowThresholds", "ShadowViolation", "ShadowMetrics", "ShadowRunResult"]
    - path: "src/shadow-mode/threshold-config.ts"
      provides: "Default shadow thresholds and enforced thresholds as constants"
      exports: ["SHADOW_THRESHOLDS", "ENFORCED_THRESHOLDS"]
    - path: "src/types.ts"
      provides: "Updated TestConfig with optional shadowMode field and PhaseResult with optional shadowResult"
      contains: "shadowMode?"
    - path: "src/config/default-config.ts"
      provides: "Shadow mode config wired into loadConfig()"
      contains: "shadowMode:"
  key_links:
    - from: "src/shadow-mode/shadow-types.ts"
      to: "src/types.ts"
      via: "TestConfig.shadowMode references ShadowModeConfig type"
      pattern: "shadowMode.*ShadowModeConfig"
    - from: "src/shadow-mode/threshold-config.ts"
      to: "src/shadow-mode/shadow-types.ts"
      via: "Threshold constants typed with ShadowThresholds interface"
      pattern: "ShadowThresholds"
    - from: "src/config/default-config.ts"
      to: "src/shadow-mode/shadow-types.ts"
      via: "loadConfig() creates ShadowModeConfig object"
      pattern: "import.*ShadowModeConfig"
---

<objective>
Create the type system and configuration for shadow mode infrastructure.

Purpose: Establish the foundational types (ShadowModeConfig, ShadowViolation, ShadowMetrics, ShadowThresholds) and dual-threshold configuration that all subsequent shadow mode plans depend on. Without these types, the shadow manager, orchestrator integration, and reporter cannot be implemented.

Output: New `src/shadow-mode/` directory with type definitions and threshold config, plus updated `types.ts` and `default-config.ts`.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-shadow-mode-measurement/10-RESEARCH.md

Key source files to read before implementing:
@dawati-tester/vertex-ai-testing/src/types.ts
@dawati-tester/vertex-ai-testing/src/config/default-config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shadow mode type definitions</name>
  <files>
    dawati-tester/vertex-ai-testing/src/shadow-mode/shadow-types.ts
  </files>
  <action>
Create `src/shadow-mode/shadow-types.ts` with the following interfaces:

```typescript
export interface ShadowModeConfig {
  enabled: boolean;
  categories: {
    rtl: boolean;
    color: boolean;
    codeQuality: boolean;
    hardcodedStrings: boolean;  // DAT-01, DAT-02
    hardcodedColors: boolean;   // DAT-14
    dynamicContent: boolean;    // DAT-15
  };
  persistMetrics: boolean;     // Save to JSON file for dashboard
  logToConsole: boolean;       // Show in test output (default false to avoid clutter)
  metricsDir: string;          // Directory for shadow-metrics.json
}

export interface ShadowThresholds {
  rtl: { enforced: number; shadow: number };
  color: { enforced: number; shadow: number };
  codeQuality: { enforced: number; shadow: number };
  hardcodedStrings: { enforced: number; shadow: number };
  hardcodedColors: { enforced: number; shadow: number };
  dynamicContent: { enforced: number; shadow: number };
}

export type ShadowCategory = 'rtl' | 'color' | 'codeQuality' | 'hardcodedStrings' | 'hardcodedColors' | 'dynamicContent';

export interface ShadowViolation {
  category: ShadowCategory;
  phaseName: string;
  suiteName: string;
  currentScore: number;
  enforcedThreshold: number;
  shadowThreshold: number;
  wouldFail: boolean;           // Would fail under shadow threshold
  currentlyFailing: boolean;    // Currently failing under enforced threshold
  details: Array<{
    name: string;
    score: number;
    issues: string[];
  }>;
}

export interface ShadowMetrics {
  phase: string;
  suite: string;
  timestamp: string;            // ISO string
  violations: ShadowViolation[];
  scores: {
    rtl?: number;
    color?: number;
    codeQuality?: number;
    hardcodedStrings?: number;
    hardcodedColors?: number;
    dynamicContent?: number;
  };
}

export interface ShadowRunResult {
  totalPhases: number;
  phasesWithViolations: number;
  violationsByCategory: Record<ShadowCategory, number>;
  wouldFailCount: number;       // Phases that would fail under shadow thresholds
  metrics: ShadowMetrics[];
}

export interface ShadowDashboardData {
  generatedAt: string;
  totalRuns: number;
  totalPhases: number;
  categoryStats: Record<ShadowCategory, {
    totalPhasesTested: number;
    wouldFailCount: number;
    wouldFailPercent: number;
    avgScore: number;
    p50Score: number;
    p95Score: number;
    enforcedThreshold: number;
    shadowThreshold: number;
    readyForEnforcement: boolean;  // true if <10% would fail
  }>;
  phaseDetails: Array<{
    phase: string;
    suite: string;
    timestamp: string;
    violations: ShadowViolation[];
  }>;
}
```

IMPORTANT: Do NOT import from `../types.ts` in this file. These types are self-contained. The orchestrator and other consumers will import from both files as needed.
  </action>
  <verify>
Run `npx tsc --noEmit` from `dawati-tester/vertex-ai-testing/` -- no type errors in the new file.
  </verify>
  <done>
shadow-types.ts exports all 7 interfaces/types with zero compilation errors. No circular dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create threshold configuration and update TestConfig</name>
  <files>
    dawati-tester/vertex-ai-testing/src/shadow-mode/threshold-config.ts
    dawati-tester/vertex-ai-testing/src/types.ts
    dawati-tester/vertex-ai-testing/src/config/default-config.ts
  </files>
  <action>
1. Create `src/shadow-mode/threshold-config.ts`:

```typescript
import { ShadowThresholds } from './shadow-types';

// Current enforced thresholds (must match test-orchestrator.ts lines 293-294, 334)
export const ENFORCED_THRESHOLDS = {
  rtl: 6.0,
  color: 5.0,
  codeQuality: 5.0,
  hardcodedStrings: 0,    // Not currently enforced
  hardcodedColors: 0,     // Not currently enforced
  dynamicContent: 0,      // Not currently enforced
};

// Shadow thresholds: stricter than enforced, used for measurement only
// These are the TARGET thresholds we want to eventually enforce in Phase 20
export const SHADOW_THRESHOLDS: ShadowThresholds = {
  rtl: { enforced: 6.0, shadow: 8.0 },
  color: { enforced: 5.0, shadow: 7.0 },
  codeQuality: { enforced: 5.0, shadow: 7.0 },
  hardcodedStrings: { enforced: 0, shadow: 6.0 },
  hardcodedColors: { enforced: 0, shadow: 6.0 },
  dynamicContent: { enforced: 0, shadow: 6.0 },
};
```

2. Update `src/types.ts` -- Add to the `TestConfig` interface (after the `fineTuning?` field):
```typescript
shadowMode?: import('./shadow-mode/shadow-types').ShadowModeConfig;
```
Actually, to avoid dynamic imports in interface, add a proper import at the top of types.ts:
```typescript
import type { ShadowModeConfig } from './shadow-mode/shadow-types';
```
...but since types.ts currently has NO imports (all types are self-contained), it's cleaner to just define `ShadowModeConfig` inline OR re-export.

BEST APPROACH: Add the ShadowModeConfig interface definition directly to types.ts as well (duplicate but clean), OR add a simple inline type:
```typescript
// In TestConfig interface, after fineTuning?:
shadowMode?: {
  enabled: boolean;
  categories: {
    rtl: boolean;
    color: boolean;
    codeQuality: boolean;
    hardcodedStrings: boolean;
    hardcodedColors: boolean;
    dynamicContent: boolean;
  };
  persistMetrics: boolean;
  logToConsole: boolean;
  metricsDir: string;
};
```

Also add to `PhaseResult` interface (after `imageAssetResult?`):
```typescript
shadowResult?: {
  violations: number;
  wouldFail: boolean;
  details: Array<{ category: string; score: number; shadowThreshold: number }>;
};
```

3. Update `src/config/default-config.ts`:
- Add `import * as path from 'path';` (already present)
- In the `loadConfig()` return object, add after `reporting:`:
```typescript
shadowMode: {
  enabled: process.env.SHADOW_MODE_ENABLED !== 'false',  // ON by default
  categories: {
    rtl: true,
    color: true,
    codeQuality: true,
    hardcodedStrings: true,
    hardcodedColors: true,
    dynamicContent: true,
  },
  persistMetrics: true,
  logToConsole: false,  // Don't clutter console; persist to JSON
  metricsDir: path.join(rootDir, 'shadow-metrics'),
},
```

CRITICAL: Do NOT modify any existing threshold enforcement in test-orchestrator.ts in this task. That happens in Plan 02.
  </action>
  <verify>
Run `npx tsc --noEmit` from `dawati-tester/vertex-ai-testing/` -- no type errors. Verify that `loadConfig()` now includes `shadowMode` by adding a temporary console.log or by checking the compiled output structure.
  </verify>
  <done>
- `threshold-config.ts` exports ENFORCED_THRESHOLDS and SHADOW_THRESHOLDS constants
- `types.ts` TestConfig includes optional `shadowMode` field
- `types.ts` PhaseResult includes optional `shadowResult` field
- `default-config.ts` loadConfig() returns shadowMode config with all categories enabled
- `npx tsc --noEmit` passes with zero errors
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `src/shadow-mode/` directory exists with `shadow-types.ts` and `threshold-config.ts`
3. `TestConfig` has `shadowMode?` property
4. `PhaseResult` has `shadowResult?` property
5. `loadConfig()` returns shadow mode config with all categories enabled by default
6. No modifications to test-orchestrator.ts (that's Plan 02)
7. No modifications to any test files
</verification>

<success_criteria>
- All shadow mode types compile without errors
- Dual thresholds defined: RTL (6.0/8.0), Color (5.0/7.0), CodeQuality (5.0/7.0), new categories (0/6.0)
- Config wired into default-config.ts with env var override (SHADOW_MODE_ENABLED)
- PhaseResult extended to carry shadow metrics
- Zero impact on existing test behavior (no orchestrator changes yet)
</success_criteria>

<output>
After completion, create `.planning/phases/10-shadow-mode-measurement/10-01-SUMMARY.md`
</output>

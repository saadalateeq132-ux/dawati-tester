\nimport { GoogleGenerativeAI } from \'@google/generative-ai\';\nimport fs from \'fs\';\nimport path from \'path\';\nimport { config } from \'./config\';\nimport { createChildLogger } from \'./logger\';\nimport { Screenshot } from \'./screenshot-manager\';\n\nconst log = createChildLogger(\'ai-analyzer\');\n\n// --- TYPE DEFINITIONS ---\nexport interface Issue {\n  id: string;\n  severity: \'critical\' | \'high\' | \'medium\' | \'low\';\n  category: \'ui\' | \'functionality\' | \'performance\' | \'rtl\' | \'accessibility\' | \'text\';\n  title: string;\n  description: string;\n  suggestion: string;\n  location?: string;\n  isBug: boolean;\n}\n\nexport interface AnalysisScores {\n  overall: number;\n  rtl: number;\n  color: number;\n  clarity: number;\n}\n\nexport interface AnalysisResult {\n  screenshot: Screenshot;\n  issues: Issue[];\n  summary: string;\n  scores: AnalysisScores;\n  confidence: number; // The AI\'s confidence in its own analysis (0-1)\n  hardcodedText: string[];\n  imageText: string[];\n  missingStates: string[];\n  timestamp: Date;\n}\n\n// --- MODULE STATE ---\nlet genAI: GoogleGenerativeAI | null = null;\nlet issueCounter = 0;\n\n// --- PRIVATE HELPERS ---\nfunction getGenAI(): GoogleGenerativeAI {\n  if (!genAI) {\n    if (!config.geminiApiKey) {\n      throw new Error(\'GEMINI_API_KEY is required for AI analysis. Set it or run with --skip-ai.\');\n    }\n    genAI = new GoogleGenerativeAI(config.geminiApiKey);\n  }\n  return genAI;\n}\n\nasync function imageToBase64(filepath: string): Promise<string> {\n  const imageBuffer = await fs.promises.readFile(filepath);\n  return imageBuffer.toString(\'base64\');\n}\n\nfunction getMimeType(filepath: string): string {\n  const ext = path.extname(filepath).toLowerCase();\n  const mimeTypes: Record<string, string> = {\n    \'.png\': \'image/png\',\n    \'.jpg\': \'image/jpeg\',\n    \'.jpeg\': \'image/jpeg\',\n  };\n  return mimeTypes[ext] || \'image/png\';\n}\n\nfunction createEmptyResult(screenshot: Screenshot): AnalysisResult {\n  return {\n    screenshot,\n    issues: [],\n    summary: \'Analysis failed or was skipped\',\n    scores: { overall: 0, rtl: 0, color: 0, clarity: 0 },\n    confidence: 0,\n    hardcodedText: [],\n    imageText: [],\n    missingStates: [],\n    timestamp: new Date(),\n  };\n}\n\n// --- CORE PROMPT ---\nconst GEMINI_PROMPT = `\nYou are a world-class QA automation expert specializing in mobile app testing for the Saudi Arabian market. Your task is to analyze a screenshot from the "Dawati" event planning app and provide a rigorous, structured quality assessment.\n\n**Primary Directives:**\n1.  **Error Page Detection:** First, check if the screen is a system-level error (e.g., 404, "Not Found", deployment error, server error). If it is, flag a single \'critical\' issue and stop.\n2.  **Comprehensive Analysis:** Analyze the screenshot against the following categories. Be extremely harsh and detail-oriented.\n    *   **RTL & Localization:** (Highest Importance for this market)\n        *   **Layout:** Is everything perfectly mirrored for a Right-to-Left (RTL) experience? Check headers, icons, navigation, and all UI components.\n        *   **Hardcoded Text:** Identify ANY English text (e.g., "Submit", "Cancel", "Loading") or hardcoded Arabic text. All text must come from a localization key (like \\\`t(\'key\')\\\`).\n        *   **BiDi Formatting:** Check for issues with mixed English/Arabic text. Pay close attention to currency (SAR, ريال), dates, and numbers. Currency symbols must appear *after* the number.\n    *   **Color & Theme:**\n        *   Does the color scheme adhere to a consistent, professional theme?\n        *   Are there any colors that clash or violate branding guidelines? (Primary color is a shade of purple).\n    *   **Clarity & UI/UX:**\n        *   Is the layout clean, intuitive, and uncluttered?\n        *   Is all text legible and easy to understand?\n        *   Are buttons and interactive elements clearly defined?\n    *   **Accessibility (A11y):** Check for low-contrast text, small touch targets, or missing element labels.\n    *   **OCR - Text in Images:** Read and report ALL text embedded within images, icons, or graphics. This text must also be localized.\n\n**Output Format (Strict JSON):**\nYou MUST respond with a single JSON object. Do not include markdown formatting like \\\`\\\`\\\`json.\n\n{\n  "issues": [\n    {\n      "severity": "critical" | "high" | "medium" | "low",\n      "category": "rtl" | "color" | "clarity" | "accessibility" | "text",\n      "title": "Short (5-10 word) summary of the issue.",\n      "description": "Detailed explanation of what is wrong.",\n      "suggestion": "A specific recommendation on how to fix it (e.g., \'Use theme.colors.primary\' or \'Localize with t(\\\\"forms.submit\\\\")\').",\n      "isBug": true | false\n    }\n  ],\n  "scores": {\n    "overall": 0-10,  // Holistic score based on all factors.\n    "rtl": 0-10,      // **STRICT:** Score 10 only if RTL is PERFECT. Deduct heavily for any layout or text issue.\n    "color": 0-10,    // Score 10 only if colors are perfectly consistent and on-brand.\n    "clarity": 0-10   // Score based on layout, legibility, and intuitive design.\n  },\n  "confidence": 0.0-1.0, // Your confidence in this analysis (e.g., 0.98).\n  "summary": "A brief, one-sentence overall assessment.",\n  "hardcodedText": ["List ALL hardcoded English or Arabic strings found."],\n  "imageText": ["List ALL text found inside images or graphics."]\n}\n\n**Scoring Guidelines:**\n*   **10:** Flawless. No issues found in the category.\n*   **9.0-9.9:** Near perfect, maybe one very minor cosmetic issue.\n*   **7.0-8.9:** Good, but has a few noticeable (medium severity) issues.\n*   **4.0-6.9:** Usable, but has significant issues (high severity) that harm the user experience.\n*   **0-3.9:** Broken, unusable, or has critical issues. A single critical issue should result in a score below 2.\n`;\n\n\n// --- PUBLIC FUNCTIONS ---\nexport async function analyzeScreenshot(screenshot: Screenshot): Promise<AnalysisResult> {\n  log.info({ filename: screenshot.filename }, \'Analyzing screenshot with Gemini\');\n  try {\n    const ai = getGenAI();\n    const model = ai.getGenerativeModel({ model: config.aiModel });\n    \n    const imageBase64 = await imageToBase64(screenshot.filepath);\n    const mimeType = getMimeType(screenshot.filepath);\n\n    const result = await model.generateContent([{ inlineData: { mimeType, data: imageBase64 }}, { text: GEMINI_PROMPT }]);\n    const response = await result.response;\n    const text = response.text();\n\n    const jsonMatch = text.match(/\\{[\\s\\S]*\\}/);\n    if (!jsonMatch) {\n      log.warn({ filename: screenshot.filename, response: text }, \'Could not parse AI response as JSON\');\n      throw new Error(\'Invalid JSON response from AI\');\n    }\n\n    const parsed = JSON.parse(jsonMatch[0]);\n\n    const issues: Issue[] = (parsed.issues || []).map((issue: Omit<Issue, \'id\' | \'screenshot\'>) => ({\n      ...issue,\n      id: `ISS-${String(++issueCounter).padStart(4, \'0\')}`,\n      screenshot: screenshot.filename,\n    }));\n\n    const analysisResult: AnalysisResult = {\n      screenshot,\n      issues,\n      summary: parsed.summary || \'No summary provided.\',\n      scores: parsed.scores || { overall: 0, rtl: 0, color: 0, clarity: 0 },\n      confidence: parsed.confidence || 0,\n      hardcodedText: parsed.hardcodedText || [],\n      imageText: parsed.imageText || [],\n      missingStates: parsed.missingStates || [],\n      timestamp: new Date(),\n    };\n\n    log.info(\n      { filename: screenshot.filename, issueCount: issues.length, score: analysisResult.scores.overall },\n      \'Analysis complete\'\n    );\n\n    return analysisResult;\n  } catch (error) {\n    log.error({ error, filename: screenshot.filename }, \'Error analyzing screenshot with Gemini\');\n    return createEmptyResult(screenshot); // Return a neutral result on error\n  }\n}\n